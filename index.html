<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudo Interativo da Bíblia</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .saved-verse-dia {
            background-color: #ffffcc; /* Cor de destaque para versículos do dia salvos */
        }
        .saved-verse-capitulo {
            background-color: #ccffff; /* Cor de destaque para versículos de capítulo salvos */
        }
        .context-menu {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        .nav-buttons {
            display: none; /* Ocultar os botões de navegação inicialmente */
        }
    </style>
</head>
<body>
    <header>
        <h1>Estudo Interativo da Bíblia</h1>
    </header>
    <main>
        <section id="search-section">
            <input type="text" id="search-input" placeholder="Digite uma palavra-chave">
            <button onclick="searchVerse()">Buscar</button>
        </section>
        <section id="verse-section">
            <h2>Versículo do Dia</h2>
            <div id="random-verse" class="verse" onclick="toggleMenu(event, 'dia')"></div>
            <div id="verse-version"></div>
            <div id="context-menu" class="context-menu">
                <button onclick="salvarVersiculo()">Salvar Versículo</button>
            </div>
            <div class="button-group">
                <label for="version-select">Versão:</label>
                <select id="version-select" onchange="updateVerseVersion()" style="width: 70px;">
                    <option value="" disabled selected>Selecione</option>
                </select>
                <button onclick="generateRandomVerse()">Outro Versículo</button>
                <button id="toggle-saved-verses" onclick="toggleVersiculosSalvos()">Versículos Salvos</button>
            </div>
        </section>
        <section id="chapter-section">
            <h2>Leitura de Capítulo</h2>
            <select id="book-select" onchange="fetchBookInfo()">
                <option value="" disabled selected>Selecione um livro</option>
            </select>
            <p id="book-info"></p>
            <input type="number" id="chapter-input" placeholder="Capítulo" min="1">
            <button onclick="readChapter()">Ler Capítulo</button>
            <div id="chapter-content"></div>
            <div id="chapter-version"></div>
            <div class="nav-buttons">
                <button onclick="prevChapter()">Capítulo Anterior</button>
                <button onclick="nextChapter()">Próximo Capítulo</button>
            </div>
        </section>
        <section id="saved-verses-section" class="hidden">
            <h2>Versículos Salvos</h2>
            <div id="saved-verses"></div>
        </section>
        <section id="resources-section">
            <h2>Recursos de Estudo</h2>
            <ul>
                <li><a href="https://www.bibliaonline.com.br/" target="_blank">Bíblia Online</a></li>
                <li><a href="https://www.biblegateway.com/" target="_blank">Bible Gateway</a></li>
                <li><a href="https://www.blueletterbible.org/" target="_blank">Blue Letter Bible</a></li>
            </ul>
        </section>
    </main>
    <script>
        let currentVersion = 'nvi';
        let currentVerseReference = null;
        let currentBook = null;
        let currentChapter = null;
        let currentClickedVerse = null;
        let currentType = null;

        async function fetchBooks() {
            try {
                const response = await fetch('https://www.abibliadigital.com.br/api/books');
                const data = await response.json();
                const bookSelect = document.getElementById('book-select');
                data.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.abbrev.pt;
                    option.textContent = book.name;
                    bookSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao buscar livros:', error);
            }
        }

        async function fetchBookInfo() {
            const book = document.getElementById('book-select').value;
            try {
                const response = await fetch(`https://www.abibliadigital.com.br/api/books/${book}`);
                const data = await response.json();
                document.getElementById('book-info').innerText = `Autor: ${data.author}, Capítulos: ${data.chapters}, Grupo: ${data.group}, Testamento: ${data.testament}`;
            } catch (error) {
                console.error('Erro ao buscar informações do livro:', error);
            }
        }

        async function fetchVersions() {
            try {
                const response = await fetch('https://www.abibliadigital.com.br/api/versions');
                const data = await response.json();
                const versionSelect = document.getElementById('version-select');
                data.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.version;
                    option.textContent = version.version.toUpperCase();
                    versionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao buscar versões:', error);
            }
        }

        async function generateRandomVerse() {
            try {
                const response = await fetch(`https://www.abibliadigital.com.br/api/verses/${currentVersion}/random`);
                const data = await response.json();
                currentVerseReference = { book: data.book.abbrev.pt, chapter: data.chapter, verse: data.number };
                document.getElementById('random-verse').innerText = `${data.book.name} ${data.chapter}:${data.number} - ${data.text}`;
                document.getElementById('verse-version').innerText = `Versão: ${currentVersion.toUpperCase()}`;
                highlightSavedVerses();
            } catch (error) {
                console.error('Erro ao buscar versículo aleatório:', error);
                document.getElementById('random-verse').innerText = 'Erro ao buscar versículo. Tente novamente mais tarde.';
                document.getElementById('verse-version').innerText = '';
            }
        }

        async function searchVerse() {
            const query = document.getElementById('search-input').value;
            const searchBody = {
                version: currentVersion,
                search: query
            };

            try {
                const response = await fetch('https://www.abibliadigital.com.br/api/verses/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchBody)
                });
                const data = await response.json();
                if (data.verses.length > 0) {
                    const verse = data.verses[0];
                    currentVerseReference = { book: verse.book.abbrev.pt, chapter: verse.chapter, verse: verse.number };
                    document.getElementById('random-verse').innerText = `${verse.book.name} ${verse.chapter}:${verse.number} - ${verse.text}`;
                    document.getElementById('verse-version').innerText = `Versão: ${currentVersion.toUpperCase()}`;
                    highlightSavedVerses();
                } else {
                    document.getElementById('random-verse').innerText = 'Nenhum versículo encontrado.';
                    document.getElementById('verse-version').innerText = '';
                }
            } catch (error) {
                console.error('Erro ao buscar versículo:', error);
                document.getElementById('random-verse').innerText = 'Erro ao buscar versículo. Tente novamente mais tarde.';
                document.getElementById('verse-version').innerText = '';
            }
        }

        async function readChapter() {
            currentBook = document.getElementById('book-select').value;
            currentChapter = document.getElementById('chapter-input').value;
            try {
                const response = await fetch(`https://www.abibliadigital.com.br/api/verses/${currentVersion}/${encodeURIComponent(currentBook)}/${currentChapter}`);
                const data = await response.json();
                if (data.verses) {
                    let chapterContent = '';
                    data.verses.forEach(verse => {
                        const verseText = `${data.book.name} ${verse.chapter}:${verse.number} - ${verse.text}`;
                        const isSaved = checkIfSaved(verseText);
                        chapterContent += `<p class="verse ${isSaved ? 'saved-verse-capitulo' : ''}" onclick="toggleMenu(event, 'capitulo', '${data.book.name}', ${verse.chapter}, ${verse.number}, '${verse.text}')"><strong>${verse.number}:</strong> ${verse.text}</p>`;
                    });
                    document.getElementById('chapter-content').innerHTML = chapterContent;
                    document.getElementById('chapter-version').innerText = `Versão: ${currentVersion.toUpperCase()}`;
                    document.querySelector('.nav-buttons').style.display = 'block'; // Mostrar botões de navegação
                } else {
                    document.getElementById('chapter-content').innerText = 'Nenhum capítulo encontrado.';
                    document.getElementById('chapter-version').innerText = '';
                }
            } catch (error) {
                console.error('Erro ao buscar capítulo:', error);
                document.getElementById('chapter-content').innerText = 'Erro ao buscar capítulo. Tente novamente mais tarde.';
                document.getElementById('chapter-version').innerText = '';
            }
        }

        async function updateVerseVersion() {
            const versionSelect = document.getElementById('version-select');
            currentVersion = versionSelect.value;
            if (currentVerseReference) {
                try {
                    const response = await fetch(`https://www.abibliadigital.com.br/api/verses/${currentVersion}/${currentVerseReference.book}/${currentVerseReference.chapter}/${currentVerseReference.verse}`);
                    const data = await response.json();
                    document.getElementById('random-verse').innerText = `${data.book.name} ${data.chapter}:${data.number} - ${data.text}`;
                    document.getElementById('verse-version').innerText = `Versão: ${currentVersion.toUpperCase()}`;
                } catch (error) {
                    console.error('Erro ao buscar versículo na nova versão:', error);
                    document.getElementById('random-verse').innerText = 'Erro ao buscar versículo. Tente novamente mais tarde.';
                    document.getElementById('verse-version').innerText = '';
                }
            }
        }

        async function prevChapter() {
            if (currentBook && currentChapter > 1) {
                currentChapter--;
                document.getElementById('chapter-input').value = currentChapter;
                readChapter();
            }
        }

        async function nextChapter() {
            if (currentBook && currentChapter) {
                currentChapter++;
                document.getElementById('chapter-input').value = currentChapter;
                readChapter();
            }
        }

        function toggleMenu(event, type, book = null, chapter = null, verse = null, text = null) {
            event.stopPropagation();
            const menu = document.getElementById('context-menu');
            currentClickedVerse = { book, chapter, verse, text };
            currentType = type;
            menu.style.display = 'block';
            menu.style.left = `${event.pageX}px`;
            menu.style.top = `${event.pageY}px`;
        }

        function salvarVersiculo() {
            const verseText = currentType === 'dia' ? document.getElementById('random-verse').innerText : `${currentClickedVerse.book} ${currentClickedVerse.chapter}:${currentClickedVerse.verse} - ${currentClickedVerse.text}`;
            const savedVerses = JSON.parse(localStorage.getItem('savedVerses')) || [];
            const currentTime = new Date().toLocaleString();
            savedVerses.push({ text: verseText, timestamp: currentTime, type: currentType });
            localStorage.setItem('savedVerses', JSON.stringify(savedVerses));
            alert('Versículo salvo com sucesso!');
            document.getElementById('context-menu').style.display = 'none';
            highlightSavedVerses();
        }

        function toggleVersiculosSalvos() {
            const savedVersesSection = document.getElementById('saved-verses-section');
            if (savedVersesSection.classList.contains('hidden')) {
                savedVersesSection.classList.remove('hidden');
                exibirVersiculosSalvos();
            } else {
                savedVersesSection.classList.add('hidden');
            }
        }

        function exibirVersiculosSalvos() {
            const savedVerses = JSON.parse(localStorage.getItem('savedVerses')) || [];
            const savedVersesSection = document.getElementById('saved-verses');
            savedVersesSection.innerHTML = '';
            savedVerses.forEach((verse, index) => {
                const verseElement = document.createElement('div');
                verseElement.classList.add('saved-verse');
                
                const textElement = document.createElement('p');
                textElement.innerText = verse.text;
                textElement.classList.add(verse.type === 'dia' ? 'saved-verse-dia' : 'saved-verse-capitulo');
                
                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Excluir';
                deleteButton.addEventListener('click', () => excluirVersiculo(index));
                
                const timestampElement = document.createElement('span');
                timestampElement.classList.add('timestamp');
                timestampElement.innerText = `Salvo em: ${verse.timestamp}`;
                
                verseElement.appendChild(textElement);
                verseElement.appendChild(deleteButton);
                verseElement.appendChild(timestampElement);
                
                savedVersesSection.appendChild(verseElement);
            });
        }

        function excluirVersiculo(index) {
            let savedVerses = JSON.parse(localStorage.getItem('savedVerses')) || [];
            savedVerses.splice(index, 1); // Remove o item do array pelo índice
            localStorage.setItem('savedVerses', JSON.stringify(savedVerses));
            exibirVersiculosSalvos(); // Atualiza a exibição dos versículos salvos
        }

        function checkIfSaved(verseText) {
            const savedVerses = JSON.parse(localStorage.getItem('savedVerses')) || [];
            return savedVerses.some(verse => verse.text === verseText);
        }

        function highlightSavedVerses() {
            const randomVerse = document.getElementById('random-verse');
            const verseText = randomVerse.innerText;
            if (checkIfSaved(verseText)) {
                randomVerse.classList.add('saved-verse-dia');
            } else {
                randomVerse.classList.remove('saved-verse-dia');
            }

            const verses = document.querySelectorAll('#chapter-content .verse');
            verses.forEach(verse => {
                const verseNumber = verse.querySelector('strong').innerText;
                const verseText = `${currentBook} ${currentChapter}:${verseNumber} - ${verse.innerText.split(`${verseNumber}: `)[1]}`;
                if (checkIfSaved(verseText)) {
                    verse.classList.add('saved-verse-capitulo');
                } else {
                    verse.classList.remove('saved-verse-capitulo');
                }
            });
        }

        window.onload = () => {
            generateRandomVerse();
            fetchBooks();
            fetchVersions();
        };

        document.addEventListener('click', (event) => {
            const menu = document.getElementById('context-menu');
            if (!event.target.closest('.verse') && event.target !== menu) {
                menu.style.display = 'none';
            }
        });
    </script>
</body>
</html>
